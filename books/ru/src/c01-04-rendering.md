# Система отрисовки

Пришло время для нашей первой системы — системы отрисовки. Она должна уметь отображать все наши сущности на экране.

## Настройка

Первым делом мы определим структуру `RenderingSystem`, которая будет нужна для доступа к контексту `ggez` чтобы запускать отрисовку.

```rust
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs:47:49}}
```

Здесь мы встречаемся с новым синтаксисом. `'a` — это аннотация жизненного цикла. Она нужна для того, чтобы компилятор мог знать, как долго ссылка в `RenderingSystem` будет доступна.

> ***ЕЩЁ:*** Узнать больше про жизненные циклы вы можете [здесь](https://doc.rust-lang.org/book/ch10-03-lifetime-syntax.html).

Теперь давайте реализуем типаж `System` для нашей системы отрисовки. Пока ничего нового особенно нет — мы просто ведём подготовительные работы. Определение `SystemData` автоматически означает, что у нас будет доступ к хранилищу позиций и отрисовываемым компонентам. Это хранилище открыто только для чтения, поэтому у нас будет только неизменяемый доступ. Но это-то нам как раз и нужно!

```rust
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs:51:57}}
        // implementation here
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs:83:84}}
```

После чего запустим нашу систему отрисовки в цикле рисования. Это значит, что каждый раз, когда игра будет обновляться, мы будем отрисовывать последнее состояние всех наших сущностей.

```rust
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs:97:111}}
```

После запуска игры всё должно скомпилироваться успешно, но, скорее всего, ничего пока не произойдёт — потому что у нас нет никакой реализации системы отрисовки и никаких сущностей.

## Реализация системы отрисовки

Ниже — реализация системы отрисовки. Она делает следующее:

- Очищает экран (мы должны быть уверены, что на нем не осталось никаких отработанных состояний с предыдущего кадра).
- Получает все отрисовываемые сущности и сортирует их по z (мы должны убедиться, что одни объекты рисуются поверх других — например, что пол находится за игроком, иначе мы не сможем его увидеть)
- Проходит по всем отсортированным сущностям и отрисовывает каждую как изображение.
- И напоследок отображает всё на экране.

```rust
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs:56:83}}
```

## Добавление тестовых сущностей

Давайте создадим несколько тестовых сущностей, чтобы убедиться, что всё работает так, как надо.

```rust
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs:179:204}}
```

И теперь соберём всё в единое целое и запустим. Вы должны увидеть что-то такое — и это суперздорово! Теперь у нас есть система отрисовки, и мы наконец-то можем видеть что-то на экране. В дальнейшем мы займёмся работой над геймплеем, чтобы сделать из нашей заготовки настоящую игру.

![Screenshot](./images/rendering.png)

Итоговый код находится ниже.

> ***Обратите внимание:*** это очень простая реализация отрисовки — она не справится с большим количеством сущностей. Более продвинутая реализация с использованием пакетной отрисовки находится в [Главе 3 — Пакетная отрисовка](/c03-04-batch-rendering.html).

```rust
{{#include ../../../code/rust-sokoban-c01-04/src/main.rs}}
```

> ***КОД:*** Увидеть весь код из данной главы можно [здесь](https://github.com/iolivia/rust-sokoban/tree/master/code/rust-sokoban-c01-04).
